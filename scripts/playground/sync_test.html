<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Sync Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .panel { border: 1px solid #ccc; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .logs { background: #f5f5f5; max-height: 300px; overflow-y: auto; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; }
        button { margin: 5px; padding: 8px 16px; }
        .firm-list { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üß™ Store Synchronization Test</h1>
    
    <div class="panel">
        <h3>Instructions</h3>
        <p>1. Open this page in multiple tabs/windows</p>
        <p>2. Click "Add Test Firm" in one tab</p>
        <p>3. Watch for updates in other tabs</p>
        <p>4. Check localStorage and BroadcastChannel sync</p>
    </div>

    <div class="panel">
        <h3>Actions</h3>
        <button onclick="addTestFirm()">Add Test Firm</button>
        <button onclick="clearStorage()">Clear Storage</button>
        <button onclick="forceRefresh()">Force Refresh</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="panel">
        <h3>Current Firms</h3>
        <div id="firmsList" class="firm-list">Loading...</div>
    </div>

    <div class="panel">
        <h3>Console Logs</h3>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        // Simulate the store structure
        let firms = [];
        let bc = null;
        
        // Initialize BroadcastChannel
        try {
            bc = new BroadcastChannel('dyeing-sync');
            bc.onmessage = (event) => {
                logMessage(`üì® Received: ${JSON.stringify(event.data)}`);
                if (event.data.type === 'FIRMS_CHANGED') {
                    loadFirms();
                }
            };
            logMessage('‚úÖ BroadcastChannel initialized');
        } catch (e) {
            logMessage('‚ùå BroadcastChannel failed: ' + e.message);
        }
        
        function logMessage(msg) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${msg}<br>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(msg);
        }
        
        function loadFirms() {
            try {
                const stored = localStorage.getItem('dyeing-firms-data');
                if (stored) {
                    firms = JSON.parse(stored);
                    logMessage(`üìã Loaded ${firms.length} firms from localStorage`);
                } else {
                    logMessage('üìã No firms found in localStorage');
                    firms = [];
                }
                updateDisplay();
            } catch (e) {
                logMessage('‚ùå Error loading firms: ' + e.message);
            }
        }
        
        function updateDisplay() {
            const firmsList = document.getElementById('firmsList');
            if (firms.length === 0) {
                firmsList.innerHTML = '<em>No firms found</em>';
            } else {
                firmsList.innerHTML = firms.map(f => 
                    `<div>üè≠ ${f.name} (ID: ${f.id})</div>`
                ).join('');
            }
        }
        
        function addTestFirm() {
            const newFirm = {
                id: Date.now(),
                name: `Test Firm ${Date.now()}`,
                created_at: new Date().toISOString()
            };
            
            firms.push(newFirm);
            
            // Save to localStorage
            localStorage.setItem('dyeing-firms-data', JSON.stringify(firms));
            localStorage.setItem('dyeing-firms-version', Date.now().toString());
            
            logMessage(`‚ûï Added firm: ${newFirm.name}`);
            
            // Broadcast the change
            if (bc) {
                bc.postMessage({ type: 'FIRMS_CHANGED', firms: firms });
                logMessage('üì° Broadcast sent');
            }
            
            updateDisplay();
        }
        
        function clearStorage() {
            localStorage.removeItem('dyeing-firms-data');
            localStorage.removeItem('dyeing-firms-version');
            localStorage.removeItem('dyeing-records-data');
            localStorage.removeItem('dyeing-records-version');
            firms = [];
            logMessage('üóëÔ∏è Storage cleared');
            updateDisplay();
        }
        
        function forceRefresh() {
            loadFirms();
            logMessage('üîÑ Force refresh completed');
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        // Initial load
        logMessage('üöÄ Test page initialized');
        loadFirms();
        
        // Listen for storage events
        window.addEventListener('storage', (e) => {
            if (e.key === 'dyeing-firms-data') {
                logMessage('üîÑ Storage event detected, reloading...');
                loadFirms();
            }
        });
    </script>
</body>
</html>
